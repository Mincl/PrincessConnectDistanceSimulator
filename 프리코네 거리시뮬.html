<head>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>

	<link rel="stylesheet" type="text/css" href="tooltip.css"/>
	<link rel="stylesheet" type="text/css" href="checkbox.css"/>
	<link rel="stylesheet" type="text/css" href="search.css"/>
	<link rel="stylesheet" type="text/css" href="main.css"/>

	<script src="https://code.jquery.com/jquery-3.3.1.min.js" type="text/javascript"></script>
	<script src="https://unpkg.com/hangul-js" type="text/javascript"></script>
	<script src="data.js" type="text/javascript"></script>
</head>

<body>
	<div id="dist_div" class="simulator">
		<div id="visual_div" class="visual_view">
			<svg id="svg">
				<!-- middle line -->
				<line x1="0%" y1="50%" x2="100%" y2="50%"/>
			</svg>
			<div id="icon_div" class="icon_view">
			</div>
		</div>
		<div id="list_div" class="list_view">
			<div>
				<input id="search" class="search" type="text" placeholder="캐릭터 검색"/>
			</div>
			<ul id="list">
			</ul>
		</div>
	</div>
</body>

<script type="text/javascript">
// const value's
// draw screen size percent
var visual_width=70;
var dist_height=35;

// padding percent
var h_pad=2;
var w_pad=5;

var max_range = 0;
var min_range = 1000;

// icon size percent by visual width
var ico_height=10;
var ico_width=0;

var party_cnt=0;
var party={
};

// 초성 추출
function getChosung(text) {
	var dis = Hangul.disassemble(text, true);
	var cho = dis.reduce(function (prev, elem) {
		elem = elem[0] ? elem[0] : elem;
		return prev + elem;
	}, "");
	return cho;
}

function resize_resource() {
	// icon width recalculate
	var ico_height_pix = $('#visual_div').height() * ico_height / 100;
	ico_width = ico_height_pix * 100 / $('#icon_div').width();

	var checkmark_height_pix = $('.checkmark').height();
	var checkmark_width = checkmark_height_pix * 100 / $('label.container').width();
	$('.checkmark').css('width', checkmark_width+'%');
	$('label.container').css('padding-left', (checkmark_width+3)+'%');
}

window.onresize = function() {
	resize_resource();
	cal_coord(party);
	update_party_icons(party);
}

window.onload = function() {
	$('#dist_div').css('height', dist_height+'%');
	$('#visual_div').css('width', visual_width+'%');

	// 초성검색까지 됨
	$('#search').bind('change keydown keyup', function() {
		var target_name = $(this).val();
		if (target_name == "") {
			$('ul li').css('display', 'block');
		} else {
			$('ul li').css('display', 'none');
			$('ul li label').each(function(idx) {
				if ($(this).text().includes(target_name)) {
					$(this).parent().css('display', 'block');
				} else if (getChosung($(this).text()).includes(target_name)) {
					$(this).parent().css('display', 'block');
				}
			});
		}
	});

	// load data
	for(key in data) {
		if (data[key].range > max_range) {
			max_range = data[key].range;
		}
		if (data[key].range < min_range) {
			min_range = data[key].range;
		}
		var li=$('<li></li>');
		li.attr('id', 'li_'+data[key].id);
		var label=$('<label class="container"></label>');
		var input=$('<input type="checkbox"/>');
		input.attr('name', data[key].id);
		input.change(function(e) {
			if(this.checked) {
				// select
				var id = $(this).attr('name');
				if (!add_member(data[id]))
					$(this).prop('checked', false);
			} else {
				// unselect
				var id = $(this).attr('name');
				if (!remove_member(data[id]))
					$(this).prop('checked', true);
			}
			update_party_icons(party);
			console.log(party_cnt);
		});
		var span=$('<span class="checkmark"></span>');
		var icon=$('<img />');
		var name=$('<span class="name">'+data[key].name+'</span>');
		icon.attr('src', data[key].icon);
		label.append(input);
		label.append(span);
		label.append(icon);
		label.append(name);
		li.append(label);
		$('#list').append(li);
	}

	resize_resource();
}

function add_member(character) {
	if (party_cnt >= 5)
		return false;

	party_cnt++;
	party[character.id] = character;
	cal_coord(party);
	add_party_icon(character);
	return true;
}

function remove_member(character) {
	if (party_cnt <= 0)
		return false;

	party_cnt--;
	delete party[character.id];
	$('#p_line_'+character.id).remove();
	$('#p_ico_'+character.id).remove();
	var chkbox = $('#li_'+character.id+' input[type="checkbox"]');
	if(chkbox.prop('checked')) {
		chkbox.prop('checked', false);
	}
	return true;
}

function makeSVG(tag, attrs) {
	var el= document.createElementNS('http://www.w3.org/2000/svg', tag);
	for (var k in attrs)
		el.setAttribute(k, attrs[k]);
	return el;
}

function makeEl(tag, attrs, styles) {
	var el= document.createElement(tag);
	for (var k in attrs)
		el.setAttribute(k, attrs[k]);
	var styleStr = "";
	for (var s in styles) {
		styleStr += s+":"+styles[s]+";";
	}
	el.setAttribute('style',styleStr);
	return el;
}

function cal_interval(range) {
	var intervals = [];
	for (r in range) {
	    intervals.push([range[r].x-(ico_width/2), range[r].x+(ico_width/2)]);
	}

	return intervals;
}

function cal_height(intervals) {

	var intervals_pos = [];
	for (i in intervals) {
		intervals_pos.push(0);
	}

	for (var pos = 1; pos <= 5; pos++) {
		var latest_left = 1000;
		for (i in intervals) {
			var left = intervals[i][0];
			var right = intervals[i][1];

			if (intervals_pos[i] == 0 && latest_left >= right) {
				latest_left = left;
				intervals_pos[i] = pos;
			}
		}
	}

	var heights = [];
	for (h in intervals_pos) {
		var h_factor = intervals_pos[h]%2*2-1;
		var h_num = parseInt((intervals_pos[h]+1)/2, 10);
		var height = h_factor * (ico_height+h_pad) * h_num;
		if (h_factor < 0)
			height += ico_height;
		heights.push(height);
	}

	return heights;
}

function add_party_icon(character) {
	// add range line
	var svg = $('#svg');
	var line_id = 'p_line_'+character.id;
	var line = makeSVG('line', {
		id: line_id,
		x1: character.center_x+'%',
		y1: character.middle_y+'%',
		x2: character.center_x+'%',
		y2: '50%'
	});
	character.line_id = line_id;
	svg.append(line);

	var div = $('#icon_div');
	var icon_id = 'p_ico_'+character.id;
	// icon div
	var party_div = $('<div class="tooltip"></div>');
	party_div.attr('id', icon_id).css('left', character.left_x+'%').css('top', character.top_y+'%')
		.css('width', ico_width+'%').css('height', ico_height+'%');
	// icon image
	var img = $('<img />');
	img.attr('src', character.icon);
	character.icon_id = icon_id;
	party_div.append(img);
	// tooltip text
	var span = $('<span class="tooltiptext"></span>');
	span.text('거리: '+character.range);
	party_div.append(span);
	party_div.click(function(e) {
		remove_member(character);
	});
	div.append(party_div);
}

function update_party_icons(party) {
	for (p in party) {
		var chara = party[p];
		var line = $('#'+chara.line_id);
		line.attr('y1', chara.middle_y+'%');
		var icon = $('#'+chara.icon_id);
		icon.css('left', chara.left_x+'%');
		icon.css('top', chara.top_y+'%');
	}
}

function cal_coord(party) {

	// calculate interval
	var range = [];
	for(p in party) {
		range.push({ range: party[p].range, id: party[p].id });
	}
	var x_range = [];
	range.sort(function(a, b) {
		if (a.range < b.range) {
			return -1;
		}
		if (a.range > b.range) {
			return 1;
		}
		return 0;
	});
	for(r in range) {
		// get reverse x percent
		var x = 100 * (1 - (range[r].range - min_range) / (max_range - min_range));
		x_range.push({ x: x, id: range[r].id });
	}
	var x_intervals = cal_interval(x_range);
	var heights = cal_height(x_intervals);
	console.log(heights);

	for (idx in x_range) {
		var id = x_range[idx].id;
		var character = party[id];

		var left_x = x_intervals[idx][0];
		var top_y = 50 - heights[idx];
		
		var middle_y = top_y + ico_height / 2;

		party[x_range[idx].id].center_x = x_range[idx].x;
		party[x_range[idx].id].middle_y = middle_y;
		party[x_range[idx].id].left_x = left_x;
		party[x_range[idx].id].top_y = top_y;
	}
}

</script>