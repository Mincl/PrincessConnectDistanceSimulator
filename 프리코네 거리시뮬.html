<head>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>

	<link rel="stylesheet" type="text/css" href="tooltip.css"/>
	<link rel="stylesheet" type="text/css" href="checkbox.css"/>
	<link rel="stylesheet" type="text/css" href="search.css"/>

	<script src="https://code.jquery.com/jquery-3.3.1.min.js" type="text/javascript"></script>
	<script src="https://unpkg.com/hangul-js" type="text/javascript"></script>
	<script src="data.js" type="text/javascript"></script>
</head>

<body style="margin:0">
	<div style="display:flex;height:35%">
		<div id="div" style="display:inline-block;width:70%;">
			<svg id="svg" style="margin:0 5%;">
				<!-- middle line -->
				<line x1="0%" y1="50%" x2="100%" y2="50%" style="stroke:rgb(0,0,0);stroke-width:2" />
			</svg>
		</div>
		<div id="list_div" style="display:inline-block;padding:2%;width:30%;">
			<div>
				<input id="search" class="search" type="text" placeholder="캐릭터 검색"/>
			</div>
			<ul id="list" style="list-style-type:none;padding-left:3%;overflow-y:scroll;">
			</ul>
		</div>
	</div>
</body>

<script type="text/javascript">
// const value's
var screen_w=600;
var screen_h=350;
var middle=screen_h / 2;

var h_pad=5;
var w_pad=25;

var max_range = 820;
var min_range = 100;

var ico_w=48;
var ico_h=48;

var party_cnt=0;
var party={
};

// 초성 추출
function getChosung(text) {
	var dis = Hangul.disassemble(text, true);
	var cho = dis.reduce(function (prev, elem) {
		elem = elem[0] ? elem[0] : elem;
		return prev + elem;
	}, "");
	return cho;
}

window.onload = function() {
	// 초성검색까지 됨
	$('#search').bind('change keydown keyup', function() {
		var target_name = $(this).val();
		if (target_name == "") {
			$('ul li').css('display', 'block');
		} else {
			$('ul li').css('display', 'none');
			$('ul li label').each(function(idx) {
				if ($(this).text().includes(target_name)) {
					$(this).parent().css('display', 'block');
				} else if (getChosung($(this).text()).includes(target_name)) {
					$(this).parent().css('display', 'block');
				}
			});
		}
	});

	// load data
	for(key in data) {
		var li=$('<li></li>');
		var label=$('<label class="container">'+data[key].name+'</label>');
		var input=$('<input type="checkbox" name="'+data[key].id+'" />');
		input.click(function() {
			console.log("click");
		});
		input.change(function(e) {
			if(this.checked) {
				// select
				var id = $(this).attr('name');
				if (!add_member(data[id]))
					$(this).prop('checked', false);
			} else {
				// unselect
				var id = $(this).attr('name');
				if (!remove_member(data[id]))
					$(this).prop('checked', true);
			}
			update_party_icons(party);
			console.log(party_cnt);
		});
		var span=$('<span class="checkmark"></span>');
		label.append(input);
		label.append(span);
		li.append(label);
		$('#list').append(li);
	}
}

function add_member(character) {
	if (party_cnt >= 5)
		return false;

	party_cnt++;
	party[character.id] = character;
	cal_coord(party);
	add_party_icon(character);
	return true;
}

function remove_member(character) {
	if (party_cnt <= 0)
		return false;

	party_cnt--;
	delete party[character.id];
	$('#p_line_'+character.id).remove();
	$('#p_ico_'+character.id).remove();
	return true;
}

function makeSVG(tag, attrs) {
	var el= document.createElementNS('http://www.w3.org/2000/svg', tag);
	for (var k in attrs)
		el.setAttribute(k, attrs[k]);
	return el;
}

function makeEl(tag, attrs, styles) {
	var el= document.createElement(tag);
	for (var k in attrs)
		el.setAttribute(k, attrs[k]);
	var styleStr = "";
	for (var s in styles) {
		styleStr += s+":"+styles[s]+";";
	}
	el.setAttribute('style',styleStr);
	return el;
}

function cal_interval(range) {
	var intervals = [];
	for (r in range) {
	    intervals.push([range[r].x-(ico_w/2), range[r].x+(ico_w/2)]);
	}

	return intervals;
}

function cal_height(intervals) {

	var intervals_pos = [];
	for (i in intervals) {
		intervals_pos.push(0);
	}

	for (var pos = 1; pos <= 5; pos++) {
		var latest_left = 1000;
		for (i in intervals) {
			var left = intervals[i][0];
			var right = intervals[i][1];

			if (intervals_pos[i] == 0 && latest_left >= right) {
				latest_left = left;
				intervals_pos[i] = pos;
			}
		}
	}

	var heights = [];
	for (h in intervals_pos) {
		var h_factor = intervals_pos[h]%2*2-1;
		var h_num = parseInt((intervals_pos[h]+1)/2, 10);
		var height = h_factor * (ico_h+h_pad) * h_num;
		if (h_factor < 0)
			height += ico_h;
		heights.push(height);
	}

	return heights;
}

function range_to_x(min_range_x, max_range_x, target_range) {
	// normalize
	var norm = (target_range-min_range)/(max_range-min_range);
	// projection to x
	var gap = norm * (min_range_x - max_range_x);
	var x = min_range_x - gap;
	return x;
}

function add_party_icon(character) {
	// add range line
	var svg = $('#svg');
	var line_id = 'p_line_'+character.id;
	var line = makeSVG('line', {
		id: line_id,
		x1: character.center_x,
		y1: character.middle_y,
		x2: character.center_x,
		y2: middle,
		style: 'stroke:rgb(0,0,0);stroke-width:2'
	});
	character.line_id = line_id;
	svg.append(line);

	var div = $('#div');
	var icon_id = 'p_ico_'+character.id;
	// icon div
	var party_div = $('<div class="tooltip" style="display:inline-block;position:absolute;"></div>');
	party_div.attr('id', icon_id).css('left', character.left_x).css('top', character.top_y);
	// icon image
	var img = $('<img />');
	img.attr('src', character.icon).css('width', ico_w).css('height', ico_h);
	character.icon_id = icon_id;
	party_div.append(img);
	// tooltip text
	var span = $('<span class="tooltiptext"></span>');
	span.text('거리: '+character.range);
	party_div.append(span);
	div.append(party_div);
}

function update_party_icons(party) {
	for (p in party) {
		var chara = party[p];
		var line = $('#'+chara.line_id);
		line.attr('y1', chara.middle_y);
		var icon = $('#'+chara.icon_id);
		icon.css('left', chara.left_x);
		icon.css('top', chara.top_y);
	}
}

function cal_coord(party) {

	var max_range_x = w_pad;
	var min_range_x = screen_w-w_pad;

	// calculate interval
	var range = [];
	for(p in party) {
		range.push({ range: party[p].range, id: party[p].id });
	}
	var x_range = [];
	range.sort(function(a, b) {
		if (a.range < b.range) {
			return -1;
		}
		if (a.range > b.range) {
			return 1;
		}
		return 0;
	});
	for(r in range) {
		var x = range_to_x(min_range_x, max_range_x, range[r].range);
		x_range.push({ x: x, id: range[r].id });
	}
	var x_intervals = cal_interval(x_range);
	var heights = cal_height(x_intervals);

	for (idx in x_range) {
		var left_x = x_intervals[idx][0];
		var top_y = middle - heights[idx];
		var center_x = (x_intervals[idx][0]+x_intervals[idx][1]) / 2;
		var middle_y = top_y + ico_h / 2;

		party[x_range[idx].id].center_x = center_x;
		party[x_range[idx].id].middle_y = middle_y;
		party[x_range[idx].id].left_x = left_x;
		party[x_range[idx].id].top_y = top_y;
	}
}

</script>